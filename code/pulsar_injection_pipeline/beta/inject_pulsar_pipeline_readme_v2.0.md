# Test Vector Pipeline (Version 2.0)                        
-
### Author: Rob Lyon
### Email : robert.lyon@manchester.ac.uk
### web   : www.scienceguyrob.com
-

This directory contains Python scripts useful for automating test vector generation. The scripts require Python 3.6 to run. This directory also contains unit tests, and unit test resources for the pipeline. These may need reconfiguring to run correctly on your machine/in your developement environment. The source code comprising the pipeline can be found in:

`pulsar_injection_pipeline/beta/main/src`

The tests are in,

`pulsar_injection_pipeline/beta/test/src`

The code requires the following libraries:

1. Scipy
2. Numpy
3. PyTest
4. Matplotlib

## Scripts

There are 4 scripts that can be directly executed. These are described in detail in their respective python files. We summarise here.

### Gaussian Profile Generator Version 1.0 (GaussianProfileGen.py)

Generates simple Gaussian or double Gaussian pulse profiles, and writes them out to .asc files compatible with the inject_pulsar tool. Pulse profile length can be varied, as can the numerical range for pulse intensity values.                                              
                                                                     
The `.asc` files produced by this script will:                         
                                                                     
1. contain pulse intensity values in ascii format. Each line in the file corresponds to a phase bin value. For example,               
                                                                     
   1.0                                                               
   2.0                                                               
   3.0                                                               
   2.0                                                               
   1.0                                                               
                                                                     
   Contains 5 bins, with a max value of 3.0, and min of 1.0.         
                                                                     
2. Have a file name that adheres to the format,                      
                                                                     
  `<ID>_DC=<Duty Cycle>_BINS=<Bins>_FWHM=<FWHM>.asc`                   
                                                                     
  where `<ID>` is a string that uniquely identifies the .asc file,     
  `<Duty Cycle>` is a float describing the fraction of the period that the pulse is "on" for, `<Bins>` is an integer describing the number of phase bins in the profile, and `<FWHM>` is a float corresponding to the full-width at half maximum (FWHM). A valid filename could be as follows:                                                           
                                                                     
      `Gaussian_DC=0.5_BINS=128_FWHM=64.asc`

--
      
### Generate Tempo 2 predictor Files Version 2.0 (GeneratePredictorFiles.py)    

Generates Tempo2 predictor files, for all `.par` files in a user specified directory. The predictor files are stored in a user defined output directory. This script will ONLY run on the `.par` files output by the `CreateFakeParFiles.py` python script. These
have a specific file name format which this script expects. You are free to create your own `.par` files manually for use with this script, though these must adhere to the file name format described in the pre-requisites section below.                
                                                                                   
Note: this script will overwrite existing predictor files during the generation   
process.                                                                           
                                                                                   
                                                                                   
Predictor files generated by this script will adhere to the file name format:      
                                                                                   
`<ID>_DM=<DM>_P0=<P0>ms_OBS=<Obs>s_F1=<F1>_F2=<F2>_T=<TC>_F=<FC>_Z=<Accel>.dat`      
                                                                                   
where `<ID>` is a string that uniquely identifies the `.dat` file, `<DM>` is a float representing the dispersion measure, `<PO>` is a float representing the period in milliseconds, `<Obs>` is an integer representing the observation length in seconds, `<F1>` and `<F2>` are floats representing the frequency in MHz of the first and the last channel respectively, `<TC>` is an integer corresponding to the number of time coefficients used in `Tempo2`, whilst `<FC>` is similarly defined but for the frequency coefficients, and finally `<Accel>` is a float that describes the          
acceleration in m/s/s.                                                             
                                                                                   

#### Pre-requisites                                                                    
                                                                                   
1. The user has generated `Tempo2` compatible `.par` files using the script `CreateFakeParFiles.py` to create valid `.par` files. The `.par` files should adhere to the following filename format:                                               
                                                                                   
   `FakePulsar<Number>_DM=<DM>_P0=<P0>ms_Z=<Accel>.par`                              
                                                                                   
   Where `<Number>` is an integer that helps identify the par file, `<DM>` is a float representing the dispersion measure, `<PO>` is a float representing the period in milliseconds, and `<Accel>` is a float that describes the acceleration in m/s/s.  
                                                                                   
2. Valid `.par` files that adhere to the naming standards mentioned above, are stored in a directory whose path is provided by the user at runtime.
                    
--

### Inject Pulsar Automator Version 2.0 (InjectPulsarAutomator.py)

Automates execution of the `inject_pulsar` C++ software module, found in Mike Keith's version of [`sigproc`](https://github.com/SixByNine/sigproc). This script uses the Python subprocess library to execute `inject_pulsar`. The input parameters required 
by `inject_pulsar` are obtained from a "Command File" that must be given to this script. A command file is a simple ascii file that contains `inject_pulsar` commands followed by a destination path. The destination path tells this script where to move `inject_pulsar's` outputs to. The format of the command file is as follows:  
  
```                                                                                  
<inject_pulsar command 1>                                                         
<Destination file name 1>                                                         
<inject_pulsar command 2>                                                         
<Destination file name 2>                                                         
<inject_pulsar command 3>                                                         
<Destination file name 3>                                                         
...                                                                               
<inject_pulsar command n>                                                         
<Destination file name n>                                                         
```                                                                              
For example,

```                                                                      
inject_pulsar --snr 35.0 --pred Fake1.dat --prof Fake1.asc Noise.fil > out.fil    
Desired_output1.fil                                                               
inject_pulsar --snr 35.0 --pred Fake2.dat --prof Fake2.asc Noise.fil > out.fil    
Desired_output2.fil                                                               
inject_pulsar --snr 35.0 --pred Fake3.dat --prof Fake3.asc Noise.fil > out.fil    
Desired_output3.fil                                                               
...
```                                                                               
                                                                                  
Here the destinations are not full paths, but file names only.                    
                                                                                  
Please note the file names used in this example are not valid according to our file name standards developed elsewhere.

--

### Inject Pulsar Command Creator Version 2.0 (InjectPulsarCommandCreator.py)

Creates a "command" file that can be used to automate use of the `inject_pulsar` tool. `inject_pulsar` is a C++ software module found in Mike Keith's version of [`sigproc`](https://github.com/SixByNine/sigproc). The command file made here is eventually used by the script InjectPulsarAutomator.py. NOTE: this script will overwrite an existing command file if given the same parameters.                            
                                                                               
Command files produced by this script have a simple file name:                 
                                                                               
`InjectPulsarCommandFile_<Batch>.txt`                                            
                                                                               
Where `<Batch>` is a user supplied parameter (with a default value of 1).        
                                                                               
A command file is a simple ascii file that contains `inject_pulsar` commands followed by a destination path. The command can be directly executed by the script `InjectPulsarAutomator.py` using the Python subprocess library. While the destination path tells `InjectPulsarAutomator.py` where to move `inject_pulsar`'s outputs to. The format of the command file is as follows:                                      

```                                                                               
<inject_pulsar command 1>                                                      
<Destination file name 1>                                                      
<inject_pulsar command 2>                                                      
<Destination file name 2>                                                      
<inject_pulsar command 3>                                                      
<Destination file name 3>                                                      
...                                                                            
<inject_pulsar command n>                                                      
<Destination file name n> 
```                                                     
                                                                               
For example,  
```                                                                 
inject_pulsar --snr 35.0 --pred Fake1.dat --prof Fake1.asc Noise.fil > out.fil 
Desired_output1.fil                                                            
inject_pulsar --snr 35.0 --pred Fake2.dat --prof Fake2.asc Noise.fil > out.fil 
Desired_output2.fil                                                            
inject_pulsar --snr 35.0 --pred Fake3.dat --prof Fake3.asc Noise.fil > out.fil 
Desired_output3.fil                                                            
...
```                                                                        
                                                                               
Here the destinations are not full paths, but file names only.                 
                                                                               
Please note the file names used in this example are not valid according to our file name standards developed as part of this work - more details on those standards below in the "Pre-requisites" section.                               
                                                                               
To generate a command, we need to know the full paths to the files that `inject_pulsar` requires to execute correctly. These pre-requisite files include a `.asc` file that describes the shape of the pulse to be injected, a `.dat` file that describes pulse arrival times, and a `.fil` (filterbank) file into which the signal will be injected.                                                              
                                                                               
Rather than pass these files in one by one, this script generates commands when given the full path to directories containing all the pre-requisite files. This means the user must provide two directory paths ( `.asc` and `.dat` directories respectively), plus a `.fil` file path.                                          
                                                                               
#### Pre-requisites                                                               
                                                                               
`inject_pulsar` is a C++ software module compiled as part of Mike Keith's version of `Sigproc`. It is used to inject pulsar signals into valid filterbank files, however to do this, it needs multiple prerequisites. These include a `.asc file` that describes the pulse to inject, a `Tempo2` predictor file (`.dat` extension) that describes pulse arrival times, and a valid noise filterbank (`.fil`) file.       
                                                                               
To proceed, this script makes a number of assumptions regarding the prerequisites:
                                                                               
1. The user has generated pulse profile files (.asc) using the script `GaussianProfileGen.py`, or some other tool that produces output files which, 
   * contain pulse intensity values in ascii format, i.e. each line in the file corresponds to a phase bin value.                                        
   * Have a file name that adheres to the format,                             
                                                                               
      `<ID>_DC=<Duty Cycle>_BINS=<Bins>_FWHM=<FWHM>.asc`                         
                                                                               
      where `<ID>` is a string that uniquely identifies the `.asc` file, `<Duty Cycle>` is a float describing the fraction of the period that the pulse is "on" for, `<Bins>` is an integer describing the number of phase bins in the profile, and `<FWHM>` is a float corresponding to the full-width at half maximum (FWHM). A valid filename could be as follows:                                      
                                                                               
      `Gaussian_DC=0.5_BINS=128_FWHM=64.asc`                                     
                                                                               
2. The user has generated `Tempo2` predictor files by firstly using the script `CreateFakeParFiles.py` to create valid `.par` files, and then passing these files as inputs to `GeneratePredictorFiles.py`, to create the valid `.dat` `Tempo2` predictor files. The `.par` files should adhere to the following filename format:
                                                                               
   `FakePulsar<Number>_DM=<DM>_P0=<P0>ms_Z=<Accel>.par`                          
                                                                               
   Where `<Number>` is an integer that helps identify the par file, `<DM>` is a float representing the dispersion measure, `<PO>` is a float representing the period in milliseconds, and `<Accel>` is a float that describes the acceleration in m/s/s.
                                                                               
   while the `.dat` files should adhere to the format:                           
                                                                               
   `<ID>_DM=<DM>_P0=<P0>ms_OBS=<Obs>s_F1=<F1>_F2=<F2>_T=<TC>_F=<FC>_Z=<Accel>.dat`
                                                                               
   where `<ID>` is a string that uniquely identifies the `.dat` file, `<DM>` is a float representing the dispersion measure, `<PO>` is a float representing the period in milliseconds, `<Obs>` is an integer representing the observation length in seconds, `<F1>` and `<F2>` are floats representing the frequency in MHz of the first and the last channel respectively, `<TC>` is an integer corresponding to the number of time coefficients used in Tempo2, whilst `<FC>` is similarly defined but for the frequency coefficients, and finally `<Accel>` is a float that describes the acceleration in m/s/s.                                                      
                                                                               
                                                                               
3. Valid `.asc` and `.dat` files that adhere to the naming standards mentioned above, are stored in directories whose paths are provided by the user at runtime. 
                                                                               
4. The user provides the full path to a valid `.fil`, filterbank file.                                                                    

--                                                                   
  